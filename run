#!/usr/bin/env node

const path = require('path')
const fs = require('fs')

// Check that project has package.json
const projectPackagePath = path.join(process.cwd(), 'package.json')
if (!fs.existsSync(projectPackagePath)) {
  console.log('No package.json found`')
  process.exit()
}

const { name = '' } = require(projectPackagePath)
if (name) console.log('Project', `"${name}"`)

// Check that project has node_modules
if (!fs.existsSync(path.join(process.cwd(), 'node_modules'))) {
  console.log('Please run `npm install` or `yarn`')
  process.exit()
}

const spawn = require('react-dev-utils/crossSpawn')

let [command, ...args] = process.argv.slice(2)

if (command==='-v') {

  const pkg = require('./package.json')

  console.log(pkg.name, pkg.version)
  process.exit()
}

const knownCommands = ['build', 'dev', 'export']

if (knownCommands.indexOf(command) < 0) command = 'help'

const run = (...cmd) => spawn.sync('node', cmd, { stdio: 'inherit' })

let result = {}

switch (command) {
case 'help':
  console.log(`
  Usage
    $ react-builder <command> [options]

  Available Commands
    build     Build the application
    dev       Start the application in development mode
    export    Export the application as a static site
`)
  break
case 'export':
  // Build for production
  result = run(require.resolve('./scripts/build'))
  // Export
  if (!result.signal) {
    process.env.APP_EXPORT = 1
    result = run('build/server.js')
  }

  break

default:
  result = run(require.resolve('./scripts/' + command))
}

process.exit(
  result.signal ? 1 : result.status
)
